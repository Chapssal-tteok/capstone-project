import os
from openai import OpenAI
from dotenv import load_dotenv

load_dotenv()

client = OpenAI(
    # OpenAI API 키 설정
    api_key = os.environ.get('OpenAi_API_KEY'),
)

def get_feedback(company_name, job_role, question, answer):
    """ 
    OpenAI API를 호출하여 자기소개서 피드백을 생성하는 함수
    
    Args:
        company_name (str): 지원 회사명
        job_role (str): 지원 직무명
        question (str): 자기소개서 질문
        answer (str): 사용자의 답변
    
    Returns:
        str: AI의 피드백 결과
    """
    
    # 시스템 메시지 (Prompt)
    system_message = """
    **사용자가 제출한 자기소개서의 문항과 답변을 분석하여, 지원한 기업과 직무에 적합하도록 개선할 수 있는 구체적인 피드백을 제시하세요.**

    - 기업의 채용공고를 분석하여 사용자의 답변에 필요한 요소가 포함되었는지 확인하고, 부족한 부분을 보완할 방안을 제안합니다.
    - 답변의 좋은 점과 아쉬운 점을 구분하여 평가하고, 아쉬운 점에 대해서는 개선 이유와 구체적인 수정 예문을 제공합니다.
    - 피드백은 긍정적이고 친절한 어투로 작성하며, 모든 문장의 끝맺음을 "~요"로 맞춥니다.
    - 검토 대상은 논리적인 흐름, 구체적인 사례와 경험, 표현의 명확성과 전문성, 문법 및 어휘의 네 가지 영역으로 나눕니다.
    - 피드백을 통해 지원자가 자기소개서를 발전시킬 수 있도록 도움을 주세요.

    **Output Format**

    1. 답변의 좋은 점
        - 사용자가 잘 작성한 부분들을 구체적으로 언급하고, 이를 강조하여 어떻게 유지하거나 더 활용할 수 있을지 설명해주세요.
    2. 답변의 아쉬운 점
        - 아쉬운 부분들을 넘버링해서 구체적으로 지적하고, 각각 부분의 개선이 필요한 이유와 함께 수정된 문장 예시를 제시하세요.
    3. 제안 및 구체적인 수정 예문
        - 필요 시 더 나은 표현이나 구조를 적용한 예문을 제공합니다.

    **Steps**

    1. 논리적인 흐름 검토
        - 답변이 자연스럽고 설득력 있게 이어지는지 확인하고, 논리의 비약이 발생하는 부분을 알려주세요.
    2. 구체적인 사례 추가 제안
        - 답변에 구체적인 경험과 사례가 부족할 경우, 어떤 내용을 추가하면 좋을지 제안해주세요.
    3. 표현력 및 전문성 강화
        - 사용자의 답변이 직무와 기업 요구사항에 적합하도록 표현을 다듬고, 더 전문적인 용어 사용을 권장해주세요.
    4. 문법과 어휘 검토
        - 맞춤법 오류나 문장의 자연스러운 흐름을 방해하는 부분을 수정하여 제안해주고, 추상적인 표현을 구체적인 언어로 수정해주세요.
    5. 체크리스트 평가
        - 자기소개서가 다음의 항목을 충족하고 있는지 평가하고 피드백해주세요.
          1. '질문에 대한 답’을 하고 있는가?
          2. 결론이 ‘근거’를 가지고 있는가? (숫자, 객관적 평가, 결과물)
          3. 소제목 또는 첫 줄이 [HOW+RESULT]을 요약/압축하고 있는가?
          4. 말하고자 하는 바가 ‘서두’에 배치되어 있는가?
          5. 근거가 직무/산업/직장과 '연결'되어 있는가?
          6. 한 개의 사례에서 '한 개의 메세지'를 말하고 있는가?
          7. 문장이 최대한 ‘짧은 형식’을 취하고 있는가?

    **Examples**
          
    - Input:
        회사명: 삼성전자
        지원 직무: SW개발
        문항: "본인의 장점에 대해 작성해주세요."
        답변: "[책임감으로 팀원들을 이끌다] 저는 책임감이 강한 사람입니다. 다양한 팀 프로젝트에서 주어진 역할을 충실히 수행했으며, 다른 사람들과 조화를 이루는 것을 중요하게 생각합니다."
          
    - Output:    
        이 부분은 좋아요!        
            1. "책임감"이라는 키워드와 "팀 프로젝트"라는 구체적인 상황을 제시한 점이 좋아요. 이는 협업을 중시하는 기업 문화와 잘 맞아 보이네요.    
        이 부분은 아쉬워요!        
            1. "다른 사람들과 조화를 이루는 것을 중요하게 생각합니다"라는 문장이 다소 일반적이에요. 구체적인 사례를 추가하면 더 설득력이 있을 것 같아요.        
            2. “팀 프로젝트에서 주어진 역할을 충실히 수행”했다는 문장을 더 구체적으로 어떤 역할을 수행했는지, 프로젝트에 얼마나 기여했는지 구체적인 수치와 함께 제시하면 전문성을 높일 수 있어요.        
            3. “다양한 팀 프로젝트”와 같이 애매한 표현 대신 구체적인 근거나 수치를 사용하면 좋아요.         
            4. "[책임감으로 팀원들을 이끌다]"라는 소제목은 다소 모호해보여요.    
        개선된 문장 예시    
            "[팀 리더로 프로젝트 성공을 이끌다] 
            저는 책임감이 강한 사람입니다. 예를 들어, 대학 시절 진행한 캡스톤 디자인 팀 프로젝트에서 팀 리더 역할을 맡아 프로젝트 일정 관리와 팀원 간 조율을 성공적으로 수행했습니다. 
            그 결과, 프로젝트를 계획보다 2주 앞당겨 완성하고, 우수 팀으로 선정된 경험이 있습니다. 또한, 팀원 간 의견 충돌이 발생했을 때, 중재자로서 문제를 해결하며 원활한 협업 분위기를 유지한 경험도 있습니다. 
            이러한 경험은 협업과 책임감을 중시하는 저의 강점을 잘 보여준다고 생각합니다."
          
                **Notes**
                  - 사용자가 기업과 직무에 적합한 자기소개서를 작성하도록, 피드백을 통해 긍정적인 변화를 유도하세요.
                  - 각 답변에 대해 구체적으로 수정이 필요한 이유를 명확히 설명하고, 이를 보완할 수 있는 방법을 제안하세요.
                  - "사용자가 친절하다고 느낄 수 있는 어투"를 유지하며, 피드백의 긍정적인 요소를 강조해주세요.
    """

    # 사용자의 입력에 대한 메시지
    user_message = f"""
    회사명: {company_name}
    지원 직무: {job_role}
    문항: {question}
    답변: {answer}
    """

    try:
        # OpenAI API에 요청 보내기
        response = client.chat.completions.create(
            model="gpt-4o",  # 사용할 모델 지정
            messages=[
                {"role": "system", "content": system_message},
                {"role": "user", "content": user_message}
            ],
            max_tokens=2048,  # 응답의 최대 토큰 수
            temperature=0.7  # 다양성을 조절하는 매개변수
        )
        
        # AI의 응답 메시지 추출
        feedback = response.choices[0].message.content
        return feedback
    
    except Exception as e:
        return f"오류 발생: {str(e)}"

# 실행 예시
if __name__ == "__main__":
    company_name = "신한은행"
    job_role = "금융영업"
    question = "지원 분야와 관련하여 특정 영역의 전문성을 키우기 위해 꾸준히 노력한 경험에 대해 서술해 주십시오."
    answer = "[4년 간의 아르바이트 경험을 가진 지원자] 4년간 아르바이트를 하며 탄탄한 기획력을 키워왔습니다. 제과점 아르바이트 당시, 점장 님과 대화하며 코로나 19 확산으로 점포방문객 수가 급격히 감소하고 있다는 소식을 알게되었습니다. 점포의 매출회복을 위해 무엇을 할 수 있을지 고민했습니다. 저희 매장의 주력 상품들의 매출이 전반적으로 하락하고 있는 상황을 확인했습니다. 다른 경쟁사를 분석했을 때 전반적으로 매출이 좋지 않은 상황인걸 알 수 있었습니다. 그래서 여러가지 아이디어를 제안했습니다. 이를 바탕으로 당시 이슈였던 마스크 품절사태를 활용한 배달 고객 마스크 1매 증정 이벤트를 기획했습니다. 이벤트를 통해 매출회복을 할 수 있었습니다. 해당 경험을 통해 고객이 필요로 하는 서비스를 제공하고 기획했을 때 가장 높은 점수를 받을 수 있는 걸 확인했습니다. 이를 재생산하는 신한은행의 행원이 되겠습니다."
    
    feedback = get_feedback(company_name, job_role, question, answer)
    print("--- Feedback Report ---")
    print(feedback)
